# Title: 2026-02-20_radar-display-transform-implementation の作業ログ

## 2026-02-20

- 16:50 #decision 実装開始に向けて設計書/実行計画のレビュー指摘を反映した。
- 16:51 #decision `camera_config` は `cameras/camera` と `radars/radar` の両形式を受理対象とした。
- 16:51 #decision backend 変換確認は新規配布データを待たず、現行データの `radars/radar` 行列で行う方針とした。
- 16:52 #note 実行計画の Status を `Active` に更新し、作業ブランチで実装を開始した。
- 17:05 #impl `PointCloud` に点群レイヤー切替、Radar 属性選択、自動正規化、LiDAR/Radar の個別 Uniform 適用 API を追加した。
- 17:11 #impl `Setting.vue` に `LiDAR / Radar / Both` 切替と Radar 専用設定（色モード、属性、自動正規化）を追加した。
- 17:14 #impl `LoadManager` / `Editor` で Radar データ有無に応じた状態同期（属性フラグ更新、未読込時クリア）を追加した。
- 17:18 #test `npm --prefix frontend/pc-tool run test:unit -- --run src/packages/pc-render/PointCloud.spec.ts` を実行し、7 tests passed を確認した。
- 17:18 #test `npm --prefix frontend/pc-tool run test:unit` を実行し、14 tests passed を確認した。
- 17:30 #test `npm --prefix frontend/pc-tool run build` を実行し、build 成功を確認した（chunk size warning のみ）。
- 08:56 #impl Setting パネルを LiDAR/Radar セクションに再編し、Radar Visible を削除した。
- 08:57 #impl Radar Attribute を Intensity トグルへ置換し、Radar/LiDAR の Color・Height・Auto Normalize を分離した。
- 08:58 #impl Setting パネルに縦スクロールを追加し、小さい画面でも全設定にアクセス可能とした。
- 08:59 #test `npm --prefix frontend/pc-tool run test:unit` を実行し、15 tests passed を確認した。
- 09:10 #test `npm --prefix frontend/pc-tool run build` を実行し、build 成功を確認した（既知 warning のみ）。
- 09:06 #impl LiDAR opacity 設定を追加し、Radar opacity と独立して反映されるようにした。
- 09:06 #test `npm --prefix frontend/pc-tool run test:unit` を実行し、16 tests passed を確認した。
- 09:44 #impl Setting パネルのレイアウトを再調整し、LiDAR/Radar セクションと Opacity 配置を要望どおりに変更した。
- 09:45 #impl 横スクロール抑制のため Setting 幅制御を見直し、主要スライダー幅を `100%` に統一した。
- 11:46 #debug Radar Height 入力欠落の原因を追跡し、`Setting.vue` の Radar 側独自レイアウトと LiDAR 側実装差分を不具合源として特定した。
- 11:47 #test `PointCloud.spec.ts` に「Radar Visible 非依存」テストを先行追加し、失敗を確認してから修正を開始した。
- 11:48 #impl `PointCloud` から `setRadarVisible` / `radarVisible` を削除し、レイヤー表示を `pointLayerMode` のみで制御するよう統一した。
- 11:49 #impl Radar Height UI を LiDAR と同型の入力配置へ揃え、`blur` 補正・範囲クランプ・リセット動作を同期した。
- 11:50 #test `npm --prefix frontend/pc-tool run test:unit` を実行し、17 tests passed を確認した。
- 11:50 #test `npm --prefix frontend/pc-tool run build` を実行し、build 成功を確認した（既知 warning のみ）。
- 12:57 #debug Playwright で `datasetId=3&dataId=29` を再現し、`TypeError: H.toFixed is not a function` により Radar Height 入力が描画失敗していることを確認した。
- 12:57 #impl `numberFormat.ts` を追加し、`Setting.vue`/`colorSlider.vue` の `a-input-number` formatter を共通化して文字列入力でも例外を出さないよう修正した。
- 12:57 #test `npm --prefix frontend/pc-tool run test:unit` を実行し、20 tests passed を確認した。
- 12:57 #test `npm --prefix frontend/pc-tool run build` を実行し、build 成功を確認した（既知 warning のみ）。
- 12:57 #test Playwright で再撮影し、Radar Height の数値入力が表示されることを確認した（`2026-02-20_playwright_tool_pc_dataset3_data29_setting_after_fix_radar_height.png`）。
- 13:12 #impl LiDAR 既存ロジック再利用方針に合わせ、`getHeightRangeByGroundAndMax` を追加し Radar 高さ初期値を `ground + max` 算出へ統一した。
- 13:12 #test `position.spec.ts` を追加し、同一データ時に LiDAR と同じ下限（ground）を使うことを固定した。
- 13:12 #test `npm --prefix frontend/pc-tool run test:unit` を実行し、22 tests passed を確認した。
- 13:12 #test `npm --prefix frontend/pc-tool run build` を実行し、build 成功を確認した（既知 warning のみ）。
- 13:57 #debug LiDAR `Auto Normalize` ON 時に Intensity セクションが消える事象を再現し、`ConfigManager.updatePointConfig` の `hasIntensity` 判定順序不整合を根因として特定した。
- 13:58 #test `ConfigManager.spec.ts` を追加して再現テストを先行作成し、失敗（`hasIntensity=false`）を確認した。
- 13:58 #impl `ConfigManager` で `intensity` 属性存在時に `hasIntensity` を維持するよう修正し、`Auto Normalize` 切替後も LiDAR 強度 UI が消えないようにした。
- 13:58 #test `npm --prefix frontend/pc-tool run test:unit -- src/packages/pc-editor/common/ConfigManager.spec.ts src/packages/pc-render/PointCloud.spec.ts` を実行し、11 tests passed を確認した。
- 13:59 #test Playwright で `datasetId=3&dataId=29` を用いた ON/OFF 切替の前後スクリーンショットを取得した（`2026-02-20_lidar-autonorm_before_toggle.png` / `2026-02-20_lidar-autonorm_after_toggle_on.png` / `2026-02-20_lidar-autonorm_after_toggle_off.png`）。
- 15:00 #impl Display 設定から LiDAR/Radar の `Auto Normalize` コントロールを削除し、関連 watcher・更新分岐・文言キーを整理した。
- 15:00 #impl `v0.9.1` 確認後に compose タグを `v0.9.1-islab` へ戻した。
- 15:01 #test `npm --prefix frontend/pc-tool run test:unit -- src/packages/pc-editor/common/ConfigManager.spec.ts src/packages/pc-render/PointCloud.spec.ts` と `npm --prefix frontend/pc-tool run build` の成功を確認した。
- 15:13 #impl Radar `Intensity` ON 時にレンジ入力とスライダーを表示する UI を追加し、LiDAR と同等の調整導線を実装した。
- 15:13 #impl Radar 読込時に intensity/snr の実データ範囲を算出して `radarIntensityRange` と `radarIntensity` を同期し、uniform `intensityRange` へ反映する処理を追加した。
- 15:14 #test `npm --prefix frontend/pc-tool run test:unit -- src/packages/pc-editor/common/ConfigManager.spec.ts src/packages/pc-render/PointCloud.spec.ts` と `npm --prefix frontend/pc-tool run build` の成功を確認した。
- 15:14 #test Playwright で Radar Intensity ON 時にレンジ入力とスライダーが表示されることを確認し、`2026-02-20_radar-intensity-controls-on.png` を取得した。
- 16:33 #debug Layer=`Both` と `Radar` の見え方が同じ件を Playwright で再現し、`mode=both` かつ `lidarVisible=true` / `radarVisible=true` を確認した。
- 16:34 #debug `Radar` と `Both` のメイン canvas 画像ハッシュが一致し、テストデータ重畳時に Radar が前面に見える描画順起因であることを確認した。
- 16:51 #debug `Radar Opacity=0` でも LiDAR が見えない件を調査し、`globalOpacity` のみ更新され `transparent=false` / `depthWrite=true` のまま深度を書き込むことを根因として特定した。
- 16:51 #impl `PointCloud.setPointOpacity` / `setRadarOpacity` に opacity 連動のマテリアル状態制御（`opacity<1` で `transparent=true` + `depthWrite=false`）を追加した。
- 16:51 #test `PointCloud.spec.ts` に深度書き込み制御テストを追加し、失敗を確認後に修正して成功させた。
- 16:52 #test `npm --prefix frontend/pc-tool run test:unit -- src/packages/pc-render/PointCloud.spec.ts src/packages/pc-editor/common/ConfigManager.spec.ts` と `npm --prefix frontend/pc-tool run build` の成功を確認した。
- 16:59 #verify Phase2.5 の確認として `data id=30 (frame 000115)` の `camera_config` を取得し、`radars[0].radar_external`（長さ 16, rowMajor=true）を確認した。
- 17:02 #verify 同一フレームの `lidar_point_cloud_0/000115.pcd` と `radar_point_cloud_0/000115.pcd` の SHA256 が一致することを確認した（現行検証データは同一点群である）。
- 17:03 #note 表示要件に合わせて LiDAR/Radar の `Auto Normalize` UI を撤去し、Intensity ON 時のみレンジコントロールを表示する構成へ更新した。
