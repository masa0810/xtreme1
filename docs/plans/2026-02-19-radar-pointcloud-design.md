# Radar 点群対応設計書

- 作成日: 2026-02-19
- 対象: `frontend/pc-tool`
- ステータス: Approved

## 背景

現状は「カメラ画像（複数台） + LiDAR 点群（1 台分）」の構成に対応している。
今後はこの構成に加えて「Radar 点群（1 台分）」を同時に扱えることが必要である。
本設計では、既存の注釈体験を壊さずに Radar 重畳表示を追加するため、最小変更での拡張方針を定義する。

## 目標

- LiDAR と Radar を同一 3D ビュー上で重畳表示できること。
- 既存の 3D 注釈編集フローを維持し、注釈対象は LiDAR 基準のままとすること。
- Radar 欠損や Radar 読込失敗時でも LiDAR ベースの作業を継続可能にすること。

## 非目標

- Radar 点群単体を注釈対象にすること。
- Radar 専用の新規注釈 UI や高度な可視化 UI（フィルタ、複雑な表示プリセット）を追加すること。
- Radar 座標を外部行列で変換する対応（初期版では同一座標系入力を前提とする）。

## 前提

- Radar 点群のファイル形式は LiDAR と同一である。
- Radar と LiDAR は同一座標系で入力される。
- 実装および検証環境は Windows 11 + WSL（Ubuntu 24.04）を想定する。
- ローカルデプロイは `docker compose` を使用可能である。
- UI 操作・動作確認には `Playwright CLI` を利用可能である。

## アーキテクチャ方針

`PointCloud` を単一点群表現から点群レイヤー表現へ拡張する。
初期版では `lidar` と `radar` の 2 レイヤーを保持し、同一 `scene` 上で重畳描画する。
注釈編集の参照対象は既存どおり LiDAR レイヤーに限定し、Radar は可視化専用レイヤーとして扱う。

## コンポーネント別設計

### 1. データ解釈層

- `BusinessManager.loadFrameConfig` で `pointcloud` に加え `radar` 系ディレクトリを検出する。
- `createViewConfig` の戻り値を `pointsUrl` 単体から、将来的拡張可能な点群レイヤー構造へ移行する。

### 2. 型定義層

- `IDataResource` に点群レイヤー構造を追加する。
- 移行期間は後方互換のため既存キーを残し、内部で `pointLayers.lidar` へ正規化する。

### 3. ロード層

- `LoadManager.setResource` で LiDAR と Radar のロード処理を分離する。
- LiDAR は既存経路を維持し、Radar は同一デコーダ経路で別レイヤーへ格納する。

### 4. 描画層

- `PointCloud` 内に Radar 用ジオメトリ、表示フラグ、透明度設定を追加する。
- LiDAR レイヤーと Radar レイヤーを同時描画する。
- 選択・編集・ヒット判定など注釈操作は LiDAR レイヤーのみを対象とする。

### 5. UI 層（最小変更）

- Radar 表示 ON/OFF を追加する。
- Radar 透明度（または輝度係数）を 1 つ追加する。
- 既存ツール群や注釈操作フローには変更を加えない。

## データフロー

1. フレーム切替時に `configs` を取得する。
2. `pointcloud` と `radar` の URL を検出し、camera 情報と合わせて `IDataResource` を構築する。
3. `LoadManager` が LiDAR を既存経路でロードし、Radar を Radar レイヤーへロードする。
4. `PointCloud` が 2 レイヤーを重畳描画する。
5. 注釈処理は LiDAR レイヤーを参照し、保存フォーマットは既存仕様を維持する。

## エラーハンドリング

- LiDAR 欠損: 致命エラーとしてロードを中断する。
- Radar 欠損: 非致命として警告のみ出し、LiDAR 単独モードで継続する。
- Radar 読込失敗（取得失敗、パース失敗、空データ）: Radar レイヤーのみ無効化し、編集作業は継続する。
- ログ/エラー文には失敗センサ種別を明記する。

## テスト設計

### 自動検証

- 純粋関数に近いセンサ抽出・分岐ロジックを優先して単体テストを追加する。
- 主な確認点は以下とする。
  - LiDAR 必須判定
  - Radar 任意判定
  - Radar 異常時フォールバック

### 手動/統合検証

- `docker compose` でローカル起動し、以下 3 パターンを確認する。
  1. LiDAR のみ
  2. LiDAR + Radar（正常）
  3. LiDAR + Radar（Radar 破損）
- `Playwright CLI` で最小スモーク（画面起動、フレーム移動、基本操作）を実施する。

## 受け入れ基準

- LiDAR + camera + Radar の構成で重畳表示できること。
- 既存の注釈作成・編集・保存が退行しないこと。
- Radar 欠損・失敗時でも LiDAR ベースの操作継続が可能であること。
- Radar 表示 ON/OFF と透明度変更が反映されること。

## 移行手順

1. 型とデータ取得を拡張し、後方互換を保つ。
2. 描画層に Radar レイヤーを追加し、注釈処理対象を LiDAR に固定する。
3. 最小 UI を追加する。
4. `docker compose` + 手動確認 + `Playwright CLI` スモークで受け入れ基準を検証する。
